# 变更日志

本文档记录 nof1-tracker 项目的所有重要变更，包括bug修复、新功能和改进。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/) 标准。

## [未发布]

### 新增
- **日志系统：自动日志轮转和文件记录** (2025-11-03)
  
  **功能描述：**
  - 创建了 `logs/` 目录用于存储日志文件
  - 所有控制台输出（console.log/error/warn/info）都会自动记录到 `logs/app.log` 文件
  - 实现了基于文件大小的自动日志轮转机制：
    * 当日志文件达到 1MB 时自动轮转
    * 轮转规则：`app.log` → `app.log.1` → `app.log.2` → ... → `app.log.50`
    * 最多保留 50 个历史日志文件，超出后自动删除最旧的文件
  - 日志文件格式包含时间戳：`YYYY-MM-DD HH:mm:ss [LEVEL] 日志消息`
  - 控制台输出保持原有格式（包含 emoji），不影响用户体验
  
  **技术实现：**
  - 使用 winston 日志库进行日志管理
  - 自定义 RotatingFileTransport 实现按大小轮转
  - 添加缓存机制优化性能（每1秒最多检查一次文件大小）
  - 在应用启动时（`src/index.ts`）自动初始化日志系统
  
  **改进：**
  - **Poll 日志增强** (2025-11-03)
    * 每次 poll 开始前自动添加日期时间标记
    * 格式：`--- YYYY MM DD HH:mm---Poll #N ---`
    * 便于在日志文件中快速定位每次轮询的时间点
    * 提升问题排查效率
  
  - **智能持仓保持功能** (2025-11-03)
    
    **问题背景：**
    - 程序重启时，即使币安已有持仓且 AI agent 的 OID 未变，系统也会无条件清仓重新开仓
    - 导致不必要的交易费用和滑点损失
    - 用户体验不佳，特别是频繁重启程序时
    
    **功能描述：**
    - 程序启动时智能检测币安现有持仓
    - 通过查询 `order-history.json` 比对 OID（订单ID）来判断持仓是否由之前的跟单创建
    - 如果 OID 匹配且方向一致（LONG/SHORT），则保持现有持仓，不执行清仓和重新开仓
    - 如果 OID 不匹配，说明 AI agent 已换仓，则执行清仓换仓逻辑（原有行为）
    - 自动标记匹配的持仓为已处理，避免重复开仓
    
    **技术实现：**
    - 新增 `isExistingPositionMatching()` 方法：
      * 检查币安仓位与当前 AI agent 的 OID 是否匹配
      * 验证持仓方向一致性（多单/空单）
      * 通过 `order-history.json` 查询历史订单进行比对
    - 修改 `handleNewPosition()` 方法：
      * 检测到币安有仓位时，先调用 OID 匹配检查
      * 匹配成功：保持持仓，标记为已处理，跳过开仓逻辑
      * 匹配失败：执行原有的清仓换仓流程
    
    **工作流程：**
    ```
    程序重启 → 检测币安仓位
             ↓
        是否有仓位？
             ↓ 是
        查询 order-history.json 中该币种最新 OID
             ↓
        OID 是否匹配？
        ├─ 是 → ✅ 保持持仓，标记已处理，跳过开仓
        └─ 否 → 🔄 清仓换仓（原有逻辑）
    ```
    
    **日志输出示例：**
    - 保持持仓：`✅ Preserving existing position for BTCUSDT (OID: 206132712257)`
    - 需要换仓：`⚠️ OID mismatch: Binance position (OID: 206132712257) vs Current (OID: 999999999)`
    
    **使用场景：**
    - ✅ 正常重启：币安有持仓，AI agent OID 未变 → 保持持仓继续监控
    - 🔄 换仓场景：AI agent 换了 OID → 清仓并跟随新仓
    - 📈 全新场景：币安无仓位 → 正常开仓
    
    **注意事项：**
    - 需要 `order-history.json` 文件存在且有历史记录才能进行匹配
    - 如果历史文件不存在或为空，会按不匹配处理（执行清仓换仓）
    - 同时检查持仓方向（多空），方向不一致视为不匹配
    
    **修改文件：**
    - `src/services/follow-service.ts` - 新增 OID 匹配检查和智能持仓保持逻辑
  
  **修改文件：**
  - `src/utils/logger.ts` - 实现日志系统和轮转机制
  - `src/index.ts` - 在应用启动时初始化日志系统
  - `src/commands/follow.ts` - 添加 poll 日期时间标记
  - `src/services/follow-service.ts` - 智能持仓保持功能

### 修复
- **Telegram消息格式错误 - 价格和数量显示为0** (2025-11-03)
  
  **问题描述：**
  - Telegram交易通知中，所有订单的价格(Price)和数量(Quantity)都显示为0.00或0
  - 影响的订单类型：所有市价单和部分限价单
  - 用户无法通过Telegram消息了解实际交易执行的价格和数量
  
  **根本原因：**
  - 对于市价单，`placeOrder` API返回时订单可能尚未完全成交
  - `orderResponse.avgPrice` 和 `orderResponse.executedQty` 在订单刚提交时可能仍为"0"字符串
  - 代码直接将API返回的原始值发送到Telegram，没有验证和处理
  
  **解决方案：**
  - 在发送Telegram消息前，检测订单类型和执行状态
  - 对于市价单或价格/数量为0的情况，等待1秒后查询订单状态获取实际执行数据
  - 实现多重备用机制：
    * **数量备用链：** `executedQty` → `origQty` → `tradingPlan.quantity`
    * **价格备用链：** `avgPrice` → 当前市场价格(`get24hrTicker`) → "Market"
  - 添加完善的错误处理，确保即使查询失败也能显示有意义的数据
  
  **技术细节：**
  - 修改文件：`src/services/trading-executor.ts`
  - 修改位置：`executePlan` 方法中的订单执行后处理逻辑（第227-322行）
  - 新增逻辑：订单状态查询 + 价格数据获取 + 多重备用机制
  
  **影响范围：**
  - 修复后，所有Telegram交易通知都会显示正确的执行价格和数量
  - 提升了用户体验，便于追踪实际交易情况

---

## [1.1.1] - 当前版本

> 注：此版本之前的变更记录将在后续更新中补充

---

## 变更类型说明

- **新增** - 新功能
- **修复** - Bug修复
- **改进** - 现有功能的改进
- **移除** - 已移除的功能
- **安全** - 安全相关的修复
- **文档** - 文档更新

