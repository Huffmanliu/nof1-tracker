# 变更日志

本文档记录 nof1-tracker 项目的所有重要变更，包括bug修复、新功能和改进。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/) 标准。

## [未发布]

### 新增
- **日志系统：自动日志轮转和文件记录** (2025-11-03)
  
  **功能描述：**
  - 创建了 `logs/` 目录用于存储日志文件
  - 所有控制台输出（console.log/error/warn/info）都会自动记录到 `logs/app.log` 文件
  - 实现了基于文件大小的自动日志轮转机制：
    * 当日志文件达到 1MB 时自动轮转
    * 轮转规则：`app.log` → `app.log.1` → `app.log.2` → ... → `app.log.50`
    * 最多保留 50 个历史日志文件，超出后自动删除最旧的文件
  - 日志文件格式包含时间戳：`YYYY-MM-DD HH:mm:ss [LEVEL] 日志消息`
  - 控制台输出保持原有格式（包含 emoji），不影响用户体验
  
  **技术实现：**
  - 使用 winston 日志库进行日志管理
  - 自定义 RotatingFileTransport 实现按大小轮转
  - 添加缓存机制优化性能（每1秒最多检查一次文件大小）
  - 在应用启动时（`src/index.ts`）自动初始化日志系统
  
  **改进：**
  - **Poll 日志增强** (2025-11-03)
    * 每次 poll 开始前自动添加日期时间标记
    * 格式：`--- YYYY MM DD HH:mm---Poll #N ---`
    * 便于在日志文件中快速定位每次轮询的时间点
    * 提升问题排查效率
  
  **修改文件：**
  - `src/utils/logger.ts` - 实现日志系统和轮转机制
  - `src/index.ts` - 在应用启动时初始化日志系统
  - `src/commands/follow.ts` - 添加 poll 日期时间标记

### 修复
- **Telegram消息格式错误 - 价格和数量显示为0** (2025-11-03)
  
  **问题描述：**
  - Telegram交易通知中，所有订单的价格(Price)和数量(Quantity)都显示为0.00或0
  - 影响的订单类型：所有市价单和部分限价单
  - 用户无法通过Telegram消息了解实际交易执行的价格和数量
  
  **根本原因：**
  - 对于市价单，`placeOrder` API返回时订单可能尚未完全成交
  - `orderResponse.avgPrice` 和 `orderResponse.executedQty` 在订单刚提交时可能仍为"0"字符串
  - 代码直接将API返回的原始值发送到Telegram，没有验证和处理
  
  **解决方案：**
  - 在发送Telegram消息前，检测订单类型和执行状态
  - 对于市价单或价格/数量为0的情况，等待1秒后查询订单状态获取实际执行数据
  - 实现多重备用机制：
    * **数量备用链：** `executedQty` → `origQty` → `tradingPlan.quantity`
    * **价格备用链：** `avgPrice` → 当前市场价格(`get24hrTicker`) → "Market"
  - 添加完善的错误处理，确保即使查询失败也能显示有意义的数据
  
  **技术细节：**
  - 修改文件：`src/services/trading-executor.ts`
  - 修改位置：`executePlan` 方法中的订单执行后处理逻辑（第227-322行）
  - 新增逻辑：订单状态查询 + 价格数据获取 + 多重备用机制
  
  **影响范围：**
  - 修复后，所有Telegram交易通知都会显示正确的执行价格和数量
  - 提升了用户体验，便于追踪实际交易情况

---

## [1.1.1] - 当前版本

> 注：此版本之前的变更记录将在后续更新中补充

---

## 变更类型说明

- **新增** - 新功能
- **修复** - Bug修复
- **改进** - 现有功能的改进
- **移除** - 已移除的功能
- **安全** - 安全相关的修复
- **文档** - 文档更新

